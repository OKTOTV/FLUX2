parameters:
    livestream_template:    "AppBundle::Mail/livestream.html.twig"
    new_post_template:      "AppBundle::Mail/new_post.html.twig"
    new_episode_template:   "AppBundle::Mail/new_episode.html.twig"
    newsletter.api_key:            "%mailchimp_api_key%"

services:
    oktothek_post_service:
        class: AppBundle\Model\PostService
        arguments: [ "@doctrine.orm.entity_manager", "@bprs.asset_helper"]

    oktothek_playlist_service:
        class:  AppBundle\Model\PlaylistService
        arguments: [ "@doctrine.orm.entity_manager", "@oktolab_media" ]

    oktothek_episode:
        class:  AppBundle\Model\EpisodeService
        arguments:  [ "@bprs_logbook", "@oktothek_notification_service", "@doctrine.orm.entity_manager" ]

    gedmo.listener.sluggable:
        class: Gedmo\Sluggable\SluggableListener
        tags:
            - { name: doctrine.event_subscriber, connection: default }
        calls:
            - [ setAnnotationReader, [ "@annotation_reader" ] ]

    mediabundle_user:
        class: MediaBundle\Form\UserType
        arguments: [ "@oktothek_user.repository" ]
        tags:
            - { name: form.type, alias: mediabundle_user }

    user_service:
        class: AppBundle\Model\UserService
        arguments: [ "@doctrine.orm.entity_manager"]

    oktothek_notification_service:
        class: AppBundle\Model\NotificationService
        arguments: [ "@doctrine.orm.entity_manager", "@bprs_user.mailer", "@translator", %livestream_template%, %new_post_template%, %new_episode_template% ]

    oktothek_coursepackage:
        class: AppBundle\Model\CoursepackageService
        arguments: [ "@form.factory", "@oktothek_academy" ]

    oktothek_tv:
        class: AppBundle\Model\TvService
        arguments: [ %program_url% ]

    # Asset repository
    oktothek_user.repository:
        class: Doctrine\ORM\EntityRepository
        factory: [ "@doctrine.orm.entity_manager", getRepository ]
        arguments:  [ AppBundle\Entity\User ]

    oktothek_search:
        class: AppBundle\Model\SearchService
        arguments: [ "@fos_elastica.finder.app.episode", "@fos_elastica.finder.app.series", "@fos_elastica.finder.app.playlist", "@fos_elastica.finder.app.coursetype", "@fos_elastica.finder.app.tag" ]

    oktothek_academy:
        class: AppBundle\Model\AcademyService
        arguments: [ "@bprs_sofort", "@doctrine.orm.entity_manager", "@router"]

    oktothek_slide:
        class: AppBundle\Model\SliderService
        arguments: [ "@bprs.asset_helper", "@doctrine.orm.entity_manager", "@router"]

    oktothek.tag_repository:
        class: Doctrine\ORM\EntityRepository
        factory:  [ "@doctrine.orm.entity_manager", getRepository ]
        arguments:  [ AppBundle\Entity\Tag ]

# voter
    oktothek_subscription_voter:
        class: AppBundle\Security\SubscriptionVoter
        tags:
            - { name: security.voter }
        # small performance boost
        public: false

    oktothek_series_post_voter:
        class:  AppBundle\Security\SeriesPostVoter
        tags:
            - { name: security.voter }
        public: false

# TWIG Extension
    oktothek.twig_extension:
        class: AppBundle\Twig\AcademyExtension
        public: false
        tags:
            - { name: twig.extension }

    oktothek.twig_episode_extension:
        class: AppBundle\Twig\EpisodeExtension
        arguments: [ "@oktothek.episode_repository"]
        public: false
        tags:
            - { name: twig.extension }

# Playlist form
    oktothek.episode_repository:
        class: Doctrine\ORM\EntityRepository
        factory:    [ "@doctrine.orm.entity_manager", getRepository ]
        arguments:  [ %oktolab_media.episode_class% ]

    oktothek.playlistitem_type:
        class: AppBundle\Form\PlaylistItemType
        arguments: [ "@oktothek.episode_repository" ]
        tags:
            - { name: form.type, alias: appbundle_playlist_item }

    oktothek.tag_collection_type:
        class: AppBundle\Form\TagCollectionType
        arguments:  [ "@oktothek.tag_repository" ]
        tags:
            - { name: form.type, alias: appbundle_tag_collection }

# newsletter
    oktothek_newsletter:
        class:  AppBundle\Model\NewsletterService
        arguments:  [ "%newsletter.api_key%" ]

# producer
    oktothek_producer_analytics:
        class:  AppBundle\Model\ProducerService
        arguments:  [ "@bprs_analytics"]

    oktothek.s3_client:
        class: Aws\S3\S3Client
        arguments:
            -
                version: 'latest' # or 'latest'
                region: "eu-central-1" # 'eu-central-1' for example
                credentials:
                    key: %oktothek_aws_key%
                    secret: %oktothek_aws_secret%

# event listener
    oktothek.comment_remove_on_episode_delete:
        class: AppBundle\Event\DeleteEpisodeEventListener
        arguments:  [ "@doctrine.orm.entity_manager" ]
        tags:
            - { name: kernel.event_listener, event: oktolab_media.delete_episode, method: onEpisodeDelete }

    oktothek.series_listener:
        class: AppBundle\Event\SeriesEventListener
        arguments: [ "@doctrine.orm.entity_manager" ]
        tags:
            - { name: kernel.event_listener, event: oktolab_media.delete_series, method: preSeriesDelete }

    oktothek.asset_listener:
        class: AppBundle\Event\AssetEventListener
        arguments: [ "@security.token_storage", "@doctrine.orm.entity_manager" ]
        tags:
            - { name: kernel.event_listener, event: bprs_asset.pre_create, method: onPrePersist }
            - { name: kernel.event_listener, event: bprs_asset.pre_delete, method: onPreDelete }
